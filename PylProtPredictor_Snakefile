from snakemake.utils import available_cpu_count
from snakemake.utils import makedirs
from pylprotpredictor.predict import predict_pyl_proteins
from pylprotpredictor.check import check_pyl_proteins
from pylprotpredictor.write_report import write_report


ref_database = "uniref90"
data_dir = "data"

makedirs(data_dir)
makedirs(config["output_dir"])


rule all:
    '''Run the complete pipeline'''
    input:
        expand(
            "{output_dir}/{file}",
            output_dir=config["output_dir"],
            file="report.html")

rule purge:
    '''Delete the output directory'''
    input:
        expand(
            "{output_dir}",
            output_dir=config["output_dir"])
    message: "!!! DELETING THE OUTPUT DIRECTORY '{input}' !!!"
    shell: "rm -rf {input}"


rule download_database:
    '''Download the UniRef90 database'''
    output:
        expand(
            "{data_dir}/{ref_database}.fasta",
            data_dir=data_dir,
            ref_database=ref_database)
    shell:
        "wget ftp://ftp.uniprot.org/pub/databases/uniprot/uniref/uniref90/uniref90.fasta.gz | gunzip"


rule prepare_database:
    '''Format the Uniref90 database for Diamond'''
    input:
        expand(
            "{data_dir}/{ref_database}.fasta",
            data_dir=data_dir,
            ref_database=ref_database)
    output:
        expand(
            "{data_dir}/{ref_database}.dmnd",
            data_dir=data_dir,
            ref_database=ref_database)
    shell:
        "diamond makedb"
        " --in {input}"
        " --db {output}"
        " --quiet"


rule predict_cds:
    '''Predict CDS from the input genome using Prodigal'''
    input:
        config["genome"]
    output:
        cds=expand(
            "{output_dir}/{file}",
            output_dir=config["output_dir"],
            file="predicted_cds.fasta"),
        info=expand(
            "{output_dir}/{file}",
            output_dir=config["output_dir"],
            file="cds_prediction_info.txt"),
        log=expand(
            "{output_dir}/{file}",
            output_dir=config["output_dir"],
            file="cds_prediction_log.txt")
    shell:
        "prodigal"
        " -i {input}"
        " -d {output.cds}"
        " -f gbk"
        " -g 11"
        " -o {output.info}"
        " 2> {output.log}"


rule predict_potential_pyl_proteins:
    '''Predict potential PYL-contrainin proteins from predicted CDS'''
    input:
        genome=config["genome"],
        predicted_cds=expand(
            "{output_dir}/{file}",
            output_dir=config["output_dir"],
            file="predicted_cds.fasta")
    output:
        potential_pyl_sequences=expand(
            "{output_dir}/{file}",
            output_dir=config["output_dir"],
            file="potential_pyl_sequences.fasta"),
        pyl_protein_prediction_log=expand(
            "{output_dir}/{file}",
            output_dir=config["output_dir"],
            file="pyl_protein_prediction_log.txt"),
        predicted_cds_info=expand(
            "{output_dir}/{file}",
            output_dir=config["output_dir"],
            file="predicted_cds.csv"),
        tag_ending_cds_info=expand(
            "{output_dir}/{file}",
            output_dir=config["output_dir"],
            file="tag_ending_cds.csv"),
        potential_pyl_protein_info=expand(
            "{output_dir}/{file}",
            output_dir=config["output_dir"],
            file="potential_pyl_proteins.csv"),
        pot_pyl_cds_obj=expand(
            "{output_dir}/{file}",
            output_dir=config["output_dir"],
            file="potential_pyl_cds_objects")
    run:
        predict_pyl_proteins(
            genome_filepath=str(input.genome),
            pred_cds_filepath=str(input.predicted_cds),
            pot_pyl_seq_filepath=str(output.potential_pyl_sequences),
            log_filepath=str(output.pyl_protein_prediction_log),
            pred_cds_info_filepath=str(output.predicted_cds_info),
            tag_ending_cds_info_filepath=str(output.tag_ending_cds_info),
            pot_pyl_seq_info_filepath=str(output.potential_pyl_protein_info),
            pot_pyl_cds_obj_filepath=str(output.pot_pyl_cds_obj))


rule search_similarity:
    '''Align predicted Pyl proteins on Uniref90 using Diamond'''
    threads: available_cpu_count()
    input:
        potential_pyl_seq=expand(
            "{output_dir}/{file}",
            output_dir=config["output_dir"],
            file="potential_pyl_sequences.fasta"),
        ref_db=expand(
            "{data_dir}/{ref_database}.dmnd",
            data_dir=data_dir,
            ref_database=ref_database)
    output:
        potential_pyl_similarity_search=expand(
            "{output_dir}/{file}",
            output_dir=config["output_dir"],
            file="potential_pyl_similarity_search.txt")
    shell:
        "diamond blastp"
        " -d {input.ref_db}"
        " -q {input.potential_pyl_seq}"
        " -o {output}"
        " -k 5"
        " -e 1e-10"
        " -f 6"
        " -b 0.5"
        " -p {threads} "
        " --quiet"


rule check_pyl_proteins:
    '''Validate potential Pyl protein by analysing the alignments'''
    input:
        pot_pyl_similarity_search=expand(
            "{output_dir}/{file}",
            output_dir=config["output_dir"],
            file="potential_pyl_similarity_search.txt"),
        pot_pyl_cds_filepath=expand(
            "{output_dir}/{file}",
            output_dir=config["output_dir"],
            file="potential_pyl_cds_objects")
    output:
        cons_pot_pyl_seq=expand(
            "{output_dir}/{file}",
            output_dir=config["output_dir"],
            file="conserved_potential_pyl_sequences.fasta"),
        info_filepath=expand(
            "{output_dir}/{file}",
            output_dir=config["output_dir"],
            file="final_cds.csv")
    run:
        check_pyl_proteins(
            pot_pyl_similarity_search=str(input.pot_pyl_similarity_search),
            pot_pyl_cds_filepath=str(input.pot_pyl_cds_filepath),
            cons_pot_pyl_seq=str(output.cons_pot_pyl_seq),
            info_filepath=str(output.info_filepath))


rule report:
    '''Print a quick HTML report'''
    input:
        pred_cds=expand(
            "{output_dir}/{file}",
            output_dir=config["output_dir"],
            file="predicted_cds.csv"),
        tag_ending_cds=expand(
            "{output_dir}/{file}",
            output_dir=config["output_dir"],
            file="tag_ending_cds.csv"),
        pot_pyl_cds=expand(
            "{output_dir}/{file}",
            output_dir=config["output_dir"],
            file="potential_pyl_proteins.csv"),
        final_cds=expand(
            "{output_dir}/{file}",
            output_dir=config["output_dir"],
            file="final_cds.csv")
    output:
        report=expand(
            "{output_dir}/{file}",
            output_dir=config["output_dir"],
            file="report.html")
    run:
        write_report(
            pred_cds=str(input.pred_cds),
            tag_ending_cds=str(input.tag_ending_cds),
            pot_pyl_cds=str(input.pot_pyl_cds),
            final_cds=str(input.final_cds),
            report_filepath=str(output.report))
